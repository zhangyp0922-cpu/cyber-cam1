<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sodeoka Swarm AR</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* 1. 视频风格化：还原视频中那种高对比度、稍微带点末日感的灰色调 */
        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* 关键滤镜：去色 + 高对比 + 稍微压暗 */
            filter: grayscale(80%) contrast(1.4) brightness(0.9) sepia(20%);
            z-index: 1;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        
        /* 启动层 */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            flex-direction: column;
        }
    </style>
</head>
<body>

<div id="container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    
    <div id="overlay" onclick="start()">
        <h1>SWARM_SIMULATION</h1>
        <p>[ 点击屏幕启动 ]</p>
    </div>
</div>

<script>
    // --- 配置参数 ---
    const config = {
        birdCount: 150,        // 鸟的数量
        birdSize: 4,           // 鸟的大小
        birdSpeed: 3,          // 飞行速度
        neighborDist: 50,      // 群聚感知的距离
        separation: 15,        // 避让距离
        color: '#1a1a1a',      // 鸟的颜色 (深黑灰，接近视频)
        hudColor: 'rgba(255, 255, 255, 0.7)', // HUD 线条颜色
        sunY: 0.3              // “太阳/雷达”在屏幕的高度比例
    };

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let w, h;
    let birds = [];

    // --- 1. 鸟群算法 (Boids) 核心类 ---
    // 这种算法模拟了鸟群的三个规则：分离(Separation)、对齐(Alignment)、凝聚(Cohesion)
    class Bird {
        constructor() {
            this.pos = { x: Math.random() * w, y: Math.random() * h };
            // 随机速度
            this.vel = { x: (Math.random() - 0.5) * config.birdSpeed, y: (Math.random() - 0.5) * config.birdSpeed };
            this.acc = { x: 0, y: 0 };
        }

        update() {
            // 限制最大速度
            const speed = Math.hypot(this.vel.x, this.vel.y);
            if (speed > config.birdSpeed) {
                this.vel.x = (this.vel.x / speed) * config.birdSpeed;
                this.vel.y = (this.vel.y / speed) * config.birdSpeed;
            }

            this.pos.x += this.vel.x;
            this.pos.y += this.vel.y;

            // 边界处理：飞出屏幕后从另一边绕回来 (环绕世界)
            if (this.pos.x < -10) this.pos.x = w + 10;
            if (this.pos.x > w + 10) this.pos.x = -10;
            if (this.pos.y < -10) this.pos.y = h + 10;
            if (this.pos.y > h + 10) this.pos.y = -10;

            // 重置加速度
            this.acc = { x: 0, y: 0 };
        }

        // 绘制：画成视频里那种“V”字形的剪影
        draw(ctx) {
            const angle = Math.atan2(this.vel.y, this.vel.x);
            
            ctx.save();
            ctx.translate(this.pos.x, this.pos.y);
            ctx.rotate(angle);
            
            ctx.fillStyle = config.color;
            ctx.beginPath();
            // 绘制一个尖锐的三角形/V形
            ctx.moveTo(config.birdSize * 2, 0);
            ctx.lineTo(-config.birdSize, -config.birdSize);
            ctx.lineTo(0, 0); // 尾部凹陷
            ctx.lineTo(-config.birdSize, config.birdSize);
            ctx.closePath();
            ctx.fill();
            
            ctx.restore();
        }

        // 核心：群聚行为
        flock(birds) {
            let alignment = { x: 0, y: 0 };
            let cohesion = { x: 0, y: 0 };
            let separation = { x: 0, y: 0 };
            let total = 0;

            for (let other of birds) {
                let d = Math.hypot(this.pos.x - other.pos.x, this.pos.y - other.pos.y);
                
                if (other !== this && d < config.neighborDist) {
                    total++;
                    
                    // 对齐：飞向邻居的平均方向
                    alignment.x += other.vel.x;
                    alignment.y += other.vel.y;

                    // 凝聚：飞向邻居的中心
                    cohesion.x += other.pos.x;
                    cohesion.y += other.pos.y;

                    // 分离：避开太近的邻居
                    if (d < config.separation) {
                        separation.x += (this.pos.x - other.pos.x) / d;
                        separation.y += (this.pos.y - other.pos.y) / d;
                    }
                }
            }

            if (total > 0) {
                // 平均化并施加力
                alignment.x /= total; alignment.y /= total;
                cohesion.x /= total; cohesion.y /= total;
                // 凝聚的目标位置减去当前位置得到向量
                cohesion.x -= this.pos.x; cohesion.y -= this.pos.y;

                // 权重调整 (调整这些可以让鸟群更松散或更紧密)
                this.vel.x += (alignment.x * 0.05 + cohesion.x * 0.01 + separation.x * 0.05);
                this.vel.y += (alignment.y * 0.05 + cohesion.y * 0.01 + separation.y * 0.05);
            }
            
            // 额外的力：稍微向屏幕中心聚拢，防止它们全部飞走
            const centerX = w / 2;
            const centerY = h * config.sunY; // 向“太阳”聚拢
            this.vel.x += (centerX - this.pos.x) * 0.0001;
            this.vel.y += (centerY - this.pos.y) * 0.0001;
        }
    }

    // --- 2. 视觉 HUD 绘制 (还原视频里的圆圈和虚线) ---
    function drawHUD() {
        const cx = w / 2;
        const cy = h * config.sunY;

        ctx.strokeStyle = config.hudColor;
        ctx.lineWidth = 1;

        // A. 太阳/雷达同心圆
        const radii = [20, 50, 90, 140];
        ctx.setLineDash([]); // 实线
        
        radii.forEach((r, i) => {
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            // 让最外圈稍微淡一点
            ctx.globalAlpha = 1 - (i * 0.2);
            ctx.stroke();
        });
        ctx.globalAlpha = 1;

        // B. 视频中的“虚线抛物线” (Dashed Arcs)
        // 模拟视频里连接左右的那些大弧线
        ctx.setLineDash([2, 4]); // 虚线
        ctx.beginPath();
        // 左弧线
        ctx.moveTo(0, h * 0.6);
        ctx.quadraticCurveTo(cx - 50, cy, 0, h * 0.2);
        ctx.stroke();
        // 右弧线
        ctx.beginPath();
        ctx.moveTo(w, h * 0.6);
        ctx.quadraticCurveTo(cx + 50, cy, w, h * 0.2);
        ctx.stroke();
        
        // C. 中心的小十字
        ctx.setLineDash([]);
        ctx.beginPath();
        ctx.moveTo(cx - 10, cy); ctx.lineTo(cx + 10, cy);
        ctx.moveTo(cx, cy - 10); ctx.lineTo(cx, cy + 10);
        ctx.stroke();

        // D. 数据文字
        ctx.fillStyle = "#fff";
        ctx.font = "14px Courier New";
        ctx.textAlign = "center";
        
        // 模拟视频里的 "237 ct"
        ctx.fillText(`${config.birdCount} ct`, cx - 80, cy);
        
        // 模拟视频里的 "1 pm" 或时钟
        const time = new Date();
        const timeStr = time.getHours() + ":" + time.getMinutes().toString().padStart(2, '0');
        ctx.fillText(timeStr, cx + 80, cy);
        
        // 底部小字
        ctx.font = "10px Courier New";
        ctx.fillText("ISOLUX_SWARM_V2 // TARGET_LOCKED", cx, h - 30);
    }

    // --- 3. 主程序 ---
    
    function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);

    function loop() {
        ctx.clearRect(0, 0, w, h);

        // 1. 绘制 HUD (在鸟的下层还是上层？视频里好像都有，放底层比较清晰)
        drawHUD();

        // 2. 更新和绘制每一只鸟
        for (let bird of birds) {
            bird.flock(birds); // 计算群体行为
            bird.update();     // 移动
            bird.draw(ctx);    // 绘制
        }

        requestAnimationFrame(loop);
    }

    async function start() {
        document.getElementById('overlay').style.display = 'none';
        resize();

        // 初始化鸟群
        for (let i = 0; i < config.birdCount; i++) {
            birds.push(new Bird());
        }

        // 启动摄像头
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                audio: false
            });
            video.srcObject = stream;
        } catch (e) {
            alert("摄像头启动失败 (请确保 HTTPS 环境)");
        }

        loop();
    }

</script>
</body>
</html>
